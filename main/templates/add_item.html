{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Create Item - PF Shop</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Back -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
        ‚Üê Back to Shop
      </a>
    </div>

    <!-- Card -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Add New Item</h1>
        <p class="text-gray-600">Fill in the details to add a new product to the shop.</p>
      </div>

      <!-- kirim ke endpoint AJAX -->
      <form id="itemForm" action="{% url 'main:add_item_entry_ajax' %}" method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" name="name"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 required>
        </div>

        <!-- Price -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
          <input type="number" name="price"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 required>
        </div>

        <!-- Stock -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
          <input type="number" name="stock" value="0"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 required>
        </div>

        <!-- Brand -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
          <input type="text" name="brand"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 required>
        </div>

        <!-- Size -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
          <input type="text" name="size"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>

        <!-- Category -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select name="category"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                  required>
            <option value="">---------</option>
            <option value="jersey">Jersey</option>
            <option value="shoes">Shoes</option>
            <option value="ball">Ball</option>
            <option value="accessory">Accessory</option>
          </select>
        </div>

        <!-- Is featured -->
        <div class="flex items-center gap-2">
          <input type="checkbox" name="is_featured" id="is_featured"
                 class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
          <label for="is_featured" class="text-sm font-medium text-gray-700">Is featured</label>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea name="description" rows="3"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
        </div>

        <!-- Thumbnail -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail</label>
          <input type="url" name="thumbnail"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 placeholder="https://...">
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
          <a href="{% url 'main:show_main' %}" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">
            Cancel
          </a>
          <button type="submit" id="submitItem" class="order-1 sm:order-2 flex-1 bg-green-600 text-white px-6 py-3 rounded-md font-medium hover:bg-green-700 transition-colors">
            Save Item
          </button>
        </div>
      </form>

      <!-- messages -->
      <div id="response-messages" class="mt-6"></div>
    </div>
  </div>
</div>

<script>
// ambil csrf
function getCookie(name){
  const value=`; ${document.cookie}`;
  const parts=value.split(`; ${name}=`);
  if(parts.length===2) return decodeURIComponent(parts.pop().split(';').shift());
}
const csrftoken = getCookie('csrftoken');

document.getElementById('itemForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn = document.getElementById('submitItem');
  const msgs = document.getElementById('response-messages');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  msgs.innerHTML = '';

  const fd = new FormData(e.target);

  try{
    const resp = await fetch(e.target.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: fd
    });
    const data = await resp.json();

    if(resp.ok){
      msgs.innerHTML = `
        <div class="p-3 rounded-md bg-green-50 border border-green-200 text-green-700">
          Item created successfully!
        </div>`;
      setTimeout(()=>window.location.href="{% url 'main:show_main' %}", 900);
    }else{
      let html = '';
      if(data.errors){
        for(const [field, errs] of Object.entries(data.errors)){
          errs.forEach(err=>{
            html += `<div class="p-3 rounded-md bg-red-50 border border-red-200 text-red-700 mb-2">
                      <strong>${field}:</strong> ${err}
                    </div>`;
          });
        }
      }else{
        html = `<div class="p-3 rounded-md bg-red-50 border border-red-200 text-red-700">
                  Failed to create item.
                </div>`;
      }
      msgs.innerHTML = html;
    }
  }catch(err){
    console.error(err);
    msgs.innerHTML = `
      <div class="p-3 rounded-md bg-red-50 border border-red-200 text-red-700">
        Network error. Please try again.
      </div>`;
  }finally{
    btn.disabled = false;
    btn.textContent = 'Save Item';
  }
});
</script>
{% endblock %}

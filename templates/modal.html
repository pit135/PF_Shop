<!-- MODAL CREATE / UPDATE ITEM -->
<div id="crudModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
  <div class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 p-6">
    <div class="flex justify-between items-center border-b pb-2 mb-4">
      <h2 id="modalTitle" class="text-xl font-bold">Create Product</h2>
      <button onclick="closeModal()" class="text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
    </div>

    <form id="productForm" action="{% url 'main:add_item_entry_ajax' %}" method="post" class="space-y-5">
      {% csrf_token %}
      <input type="hidden" id="productId" name="id">

      <div>
        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" id="productName" name="name"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
          required>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
          <input type="number" id="productPrice" name="price"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
            required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
          <input type="number" id="productStock" name="stock"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
            required>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
          <input type="text" id="productBrand" name="brand"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
            required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
          <input type="text" id="productSize" name="size"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="productCategory" name="category"
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:ring-2 focus:ring-green-500 focus:border-green-500">
          <option value="">---------</option>
          <option value="jersey">Jersey</option>
          <option value="shoes">Shoes</option>
          <option value="ball">Ball</option>
          <option value="accessory">Accessory</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" id="productFeatured" name="is_featured"
          class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
        <label for="productFeatured" class="text-sm font-medium text-gray-700">Featured</label>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea id="productDescription" name="description" rows="3"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail (URL)</label>
        <input type="url" id="productThumbnail" name="thumbnail"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
          placeholder="https://...">
      </div>

      <div class="flex justify-end gap-3 border-t pt-4">
        <button type="button" onclick="closeModal()"
          class="px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100">
          Cancel
        </button>
        <button type="submit" id="submitButton"
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
          Save
        </button>
      </div>
    </form>

    <p id="responseMessage" class="mt-3 text-sm hidden"></p>
  </div>
</div>

<!-- MODAL KONFIRMASI DELETE -->
<div id="deleteConfirmModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
  <div class="bg-white rounded-lg shadow-lg w-80 p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Delete Product</h2>
    <p class="text-gray-700 mb-2">Are you sure you want to delete this product?</p>
    <p class="text-gray-500 mb-6 text-sm">This action cannot be undone.</p>

    <div class="flex justify-end gap-3">
      <button onclick="closeDeleteModal()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100">
        Cancel
      </button>
      <button id="confirmDeleteBtn"
              class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
        Delete
      </button>
    </div>
  </div>
</div>

<script>
function showModal(){ document.getElementById('crudModal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('crudModal').classList.add('hidden'); }

const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
const CSRF_TOKEN = csrfInput ? csrfInput.value : '';
const CREATE_URL = "{% url 'main:add_item_entry_ajax' %}";

// buka modal create / edit
function openProductModal(mode, data = null){
  showModal();
  const form  = document.getElementById('productForm');
  const title = document.getElementById('modalTitle');
  const btn   = document.getElementById('submitButton');

  form.reset();

  if (mode === "create") {
    title.textContent = "Create Product";
    btn.textContent   = "Create";
    form.dataset.mode = "create";
    delete form.dataset.id;
  } else {
    title.textContent = "Update Product";
    btn.textContent   = "Update";
    form.dataset.mode = "edit";
    form.dataset.id   = data.id;

    document.getElementById('productName').value        = data.name || '';
    document.getElementById('productPrice').value       = data.price || '';
    document.getElementById('productStock').value       = data.stock || '';
    document.getElementById('productBrand').value       = data.brand || '';
    document.getElementById('productSize').value        = data.size || '';
    document.getElementById('productCategory').value    = data.category || '';
    document.getElementById('productFeatured').checked  = !!data.is_featured;
    document.getElementById('productDescription').value = data.description || '';
    document.getElementById('productThumbnail').value   = data.thumbnail || '';
  }
}

// submit create / update
document.getElementById('productForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('submitButton');
  const msg = document.getElementById('responseMessage');
  btn.disabled = true;
  msg.classList.add('hidden');

  const fd = new FormData(this);
  let url = CREATE_URL;

  if (this.dataset.mode === 'edit') {
    url = `{% url 'main:edit_item' '00000000-0000-0000-0000-000000000000' %}`
      .replace('00000000-0000-0000-0000-000000000000', this.dataset.id);
  }

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: fd
    });
    const data = await res.json().catch(() => ({}));

    if (res.ok) {
      const action = this.dataset.mode === 'create' ? 'created' : 'updated';
      if (typeof showToast === 'function') {
        showToast(`Product ${action} successfully!`, 'success'); 
      }
      document.dispatchEvent(new CustomEvent('itemAdded'));
      setTimeout(() => closeModal(), 700);
    } else {
      if (typeof showToast === 'function') {
        showToast('Failed to save product', 'error');        
      }
      msg.textContent = data.message || 'Failed to save product';
      msg.classList.remove('hidden');
      msg.classList.add('text-red-600');
    }
  } catch (err) {
    console.error(err);
    if (typeof showToast === 'function') {
      showToast('Network error', 'error');                     
    }
  } finally {
    btn.disabled = false;
  }
});


/* MODAL KONFIRMASI DELETE */
let productToDelete = null;

function openDeleteModal(itemId) {
  productToDelete = itemId;
  document.getElementById('deleteConfirmModal').classList.remove('hidden');
}

function closeDeleteModal() {
  productToDelete = null;
  document.getElementById('deleteConfirmModal').classList.add('hidden');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
  if (!productToDelete) return;

  const deleteUrl = `{% url 'main:delete_item' '00000000-0000-0000-0000-000000000000' %}`
    .replace('00000000-0000-0000-0000-000000000000', productToDelete);

  try {
    const res = await fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': CSRF_TOKEN,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    if (res.ok) {
      if (typeof showToast === 'function') {
        showToast('Product deleted successfully!', 'success');    
      }
      document.dispatchEvent(new CustomEvent('itemAdded'));
      closeDeleteModal();
    } else {
      if (typeof showToast === 'function') {
        showToast('Failed to delete product.', 'error');    
      }
    }
  } catch (err) {
    console.error(err);
    if (typeof showToast === 'function') {
      showToast('Network error', 'error');               
    }
  }
});
</script>
